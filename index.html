<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Ular - Tembok Tembus</title>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #222;
            color: white;
            /* Mencegah zoom/scroll di mobile saat menekan tombol */
            touch-action: manipulation;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        #score {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            min-height: 1.5em; /* Jaga ruang agar tidak melompat */
        }

        /* Kontainer untuk kanvas dan overlay */
        .game-container {
            position: relative;
            border: 4px solid #555;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            /* Pastikan ukuran konsisten */
            width: 400px;
            height: 400px;
        }

        canvas {
            display: block;
            background-color: #111;
            width: 100%;
            height: 100%;
        }

        /* Overlay untuk Game Over */
        #gameOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Sembunyi secara default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        #gameOverlay h2 {
            font-size: 2.5rem;
            margin: 0;
            color: #ff4136; /* Merah */
        }
        
        #gameOverlay p {
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        #playAgainButton {
            font-size: 1.2rem;
            padding: 0.75rem 1.5rem;
            margin-top: 1.5rem;
            background-color: #2ecc71; /* Hijau */
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Kontrol Papan Keyboard di Layar */
        #controls {
            display: grid;
            grid-template-columns: 80px 80px 80px;
            grid-template-rows: 80px 80px;
            gap: 10px;
            margin-top: 20px;
            /* Sembunyikan di layar besar, tampilkan di layar kecil */
            display: none;
        }

        #controls button {
            font-size: 2rem;
            border: none;
            border-radius: 12px;
            background-color: #555;
            color: white;
            cursor: pointer;
            /* Mencegah highlight biru saat disentuh */
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* Mencegah seleksi teks */
        }
        
        #controls button:active {
            background-color: #777;
        }

        /* Posisi D-Pad */
        #btnUp { grid-column: 2; grid-row: 1; }
        #btnLeft { grid-column: 1; grid-row: 2; }
        #btnDown { grid-column: 2; grid-row: 2; }
        #btnRight { grid-column: 3; grid-row: 2; }
        
        /* Media query untuk menampilkan tombol di perangkat mobile/kecil */
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            #score { font-size: 1.2rem; }
            .game-container {
                width: 90vw;
                height: 90vw;
                max-width: 400px;
                max-height: 400px;
            }
            #controls {
                display: grid;
            }
        }
    </style>
</head>
<body>

    <h1>Snake Game</h1>
    <h2 id="score">Skor: 0</h2>

    <div class="game-container">
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        
        <div id="gameOverlay">
            <h2>Game Over</h2>
            <p id="finalScore"></p>
            <button id="playAgainButton">Main Lagi</button>
        </div>
    </div>

    <div id="controls">
        <button id="btnUp">▲</button>
        <button id="btnLeft">◀</button>
        <button id="btnDown">▼</button>
        <button id="btnRight">▶</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. Seleksi Elemen DOM ===
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const overlay = document.getElementById('gameOverlay');
            const finalScoreDisplay = document.getElementById('finalScore');
            const playAgainButton = document.getElementById('playAgainButton');
            
            // Tombol Kontrol
            const btnUp = document.getElementById('btnUp');
            const btnLeft = document.getElementById('btnLeft');
            const btnDown = document.getElementById('btnDown');
            const btnRight = document.getElementById('btnRight');

            // === 2. Konstanta Game ===
            const gridSize = 20; 
            const tileCount = canvas.width / gridSize; // 400 / 20 = 20
            const gameSpeed = 120; // 120ms per frame

            // === 3. Variabel Status Game ===
            let snake, food, velocity, score, isGameOver, gameLoopInterval;

            /**
             * Memulai atau me-reset permainan
             */
            function startGame() {
                snake = [ { x: 10, y: 10 } ]; // Mulai dengan 1 segmen
                velocity = { x: 0, y: 0 }; // Diam sampai ada input
                score = 0;
                isGameOver = false;

                overlay.style.display = 'none';
                updateScoreUI();
                spawnFood();

                if (gameLoopInterval) clearInterval(gameLoopInterval);
                gameLoopInterval = setInterval(gameLoop, gameSpeed);
            }

            /**
             * Game Loop Utama
             */
            function gameLoop() {
                if (isGameOver) return;
                
                // Hanya bergerak jika ada kecepatan (setelah input pertama)
                if (velocity.x !== 0 || velocity.y !== 0) {
                    moveSnake();
                    checkCollision();
                }
                drawGame();
            }

            /**
             * Menggambar semua elemen ke kanvas
             */
            function drawGame() {
                // Latar belakang
                ctx.fillStyle = '#111';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Ular
                ctx.fillStyle = 'limegreen';
                snake.forEach(segment => {
                    ctx.fillRect(
                        segment.x * gridSize, 
                        segment.y * gridSize, 
                        gridSize - 1, 
                        gridSize - 1
                    );
                });

                // Makanan
                ctx.fillStyle = 'red';
                ctx.fillRect(
                    food.x * gridSize, 
                    food.y * gridSize, 
                    gridSize - 1, 
                    gridSize - 1
                );
            }

            /**
             * Memperbarui posisi ular
             */
            function moveSnake() {
                const head = { 
                    x: snake[0].x + velocity.x, 
                    y: snake[0].y + velocity.y 
                };

                // === MODIFIKASI: TEMBOK TEMBUS (WRAP-AROUND) ===
                if (head.x < 0) head.x = tileCount - 1;
                if (head.x >= tileCount) head.x = 0;
                if (head.y < 0) head.y = tileCount - 1;
                if (head.y >= tileCount) head.y = 0;

                snake.unshift(head); // Tambah kepala baru

                // Cek makan makanan
                if (head.x === food.x && head.y === food.y) {
                    score++;
                    updateScoreUI();
                    spawnFood();
                    // Jangan hapus ekor (snake.pop())
                } else {
                    snake.pop(); // Hapus ekor jika tidak makan
                }
            }

            /**
             * Memeriksa kondisi kalah (hanya tabrak diri sendiri)
             */
            function checkCollision() {
                const head = snake[0];

                // === MODIFIKASI: HANYA CEK TABRAK DIRI ===
                // Mulai dari i=1 (abaikan kepala)
                for (let i = 1; i < snake.length; i++) {
                    if (head.x === snake[i].x && head.y === snake[i].y) {
                        triggerGameOver();
                        return;
                    }
                }
            }

            /**
             * Memunculkan makanan di posisi acak
             */
            function spawnFood() {
                do {
                    food = {
                        x: Math.floor(Math.random() * tileCount),
                        y: Math.floor(Math.random() * tileCount)
                    };
                } while (isPositionOnSnake(food)); // Ulangi jika muncul di atas ular
            }

            function isPositionOnSnake(position) {
                return snake.some(segment => 
                    segment.x === position.x && segment.y === position.y
                );
            }

            function updateScoreUI() {
                scoreDisplay.textContent = `Skor: ${score}`;
            }

            function triggerGameOver() {
                isGameOver = true;
                clearInterval(gameLoopInterval);
                finalScoreDisplay.textContent = `Skor Akhir: ${score}`;
                overlay.style.display = 'flex';
            }

            /**
             * Fungsi terpusat untuk mengubah arah
             */
            function changeDirection(dx, dy) {
                // Mencegah berbalik arah 180 derajat
                const movingUp = velocity.y === -1;
                const movingDown = velocity.y === 1;
                const movingLeft = velocity.x === -1;
                const movingRight = velocity.x === 1;

                if (dy === -1 && !movingDown) { // Atas
                    velocity = { x: 0, y: -1 };
                } else if (dy === 1 && !movingUp) { // Bawah
                    velocity = { x: 0, y: 1 };
                } else if (dx === -1 && !movingRight) { // Kiri
                    velocity = { x: -1, y: 0 };
                } else if (dx === 1 && !movingLeft) { // Kanan
                    velocity = { x: 1, y: 0 };
                }
            }

            // === 4. Event Listeners ===
            
            // Listener Keyboard
            document.addEventListener('keydown', (event) => {
                switch (event.key) {
                    case 'ArrowUp':
                    case 'w':
                        changeDirection(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                        changeDirection(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        changeDirection(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                        changeDirection(1, 0);
                        break;
                }
            });
            
            // Listener Tombol di Layar
            btnUp.addEventListener('click', () => changeDirection(0, -1));
            btnDown.addEventListener('click', () => changeDirection(0, 1));
            btnLeft.addEventListener('click', () => changeDirection(-1, 0));
            btnRight.addEventListener('click', () => changeDirection(1, 0));

            // Listener Tombol "Main Lagi"
            playAgainButton.addEventListener('click', startGame);

            // === 5. Mulai Game ===
            startGame();
        });
    </script>

</body>
</html>
